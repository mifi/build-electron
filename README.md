# build-electron [![Test](https://github.com/mifi/build-electron/actions/workflows/test.yml/badge.svg)](https://github.com/mifi/build-electron/actions/workflows/test.yml)

Use ES modules in Electron now!

`build-electron` is a simple build tool for **main** and **preload** code of your Electron app, so you don't have to setup a webpack build system yourself. The aim is to make it easier to get started building Electron apps, like it used to be. Note that **`build-electron` is not a boilerplate**. It is a build tool kind of like Create React App or Vite, but for your Electron code.

## Background

Because [Electron does not support ES Modules](https://github.com/electron/electron/issues/21457), and the [Node ecosystem is shifting to ESM](https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c) we are lacking an easy way to simply use ESM Node.js code and modules in our Electron projects. A boilerplate is possible, but it can get outdated quickly and hard to maintain with new updates. So I created this project in the spirit of [Create React App](https://github.com/facebook/create-react-app). When Electron supports ESM in the future ğŸ¤, `build-electron` can simply be unplugged from the project and it will hopefully "just work".

## Features

- Simple - Doesn't build frontend; less hairy logic
- Supports Webpack 5
- Customizable
- Building for production or watching

## How to use

Note that this project provides **Node.js code building only** (main, preload) - not renderer code due to there being so many different languages and frameworks for that, and there are already excellent tools for building those. For React based Electron apps, I recommend pairing with [Vite](https://vitejs.dev/) or [Create React App (CRA)](https://github.com/facebook/create-react-app).

```bash
yarn add -D build-electron concurrently wait-on
```

Put your Electron main ESM source code in `src/main/index.js` and preload source in `src/preload/index.js`.

Now create a configuration file in your project root `build-electron.config.js` (project root means the same directory that you have your Electron project's `package.json` file):

```js
module.exports = {
  mainEntry: 'src/main/index.js',
  preloadEntry: 'src/preload/index.js',
  outDir: 'build',
  mainTarget: 'electron16.0-main',
  preloadTarget: 'electron16.0-preload',
}
```

Add to your `package.json`:

```json
{
  "main": "build/main.js",
  "build": {
    "files": [
      "build/**/*"
    ]
  },
  "scripts": {
    "start": "concurrently -k \"build-electron -d\" \"wait-on build/.build-electron-done && electron .\"",
    "build": "build-electron"
  }
```

See example folder structure:

```
ğŸ“ My Electron App
  ğŸ“„ package.json
  ğŸ“„ build-electron.config.js
  ğŸ“ src
    ğŸ“ main
      ğŸ“„ index.js
      [more sources]
    ğŸ“ preload
      ğŸ“„ index.js
      [more sources]

  ğŸ“ build
    ğŸ“„ main.js [generated by build-electron]
    ğŸ“„ preload.js [generated by build-electron]
```

Now you can start developing:
```bash
npm run start
```

And to build your production app:
```bash
npm run build && npm exec electron-builder --mac
```

Optionally add your frontend builder (for example CRA, see example below)

## Using with Create React App

In this example we will use CRA and [electron-builder](https://www.electron.build/), although it should be similar with any other framework too.

```bash
yarn create react-app my-awesome-app
cd my-awesome-app
yarn add -D build-electron electron electron-builder concurrently wait-on
```

Now let's create the project structure. Because CRA uses a particular directory structure (and `src` is reserved for the frontend source), we have to adapt to that. The relevant structure will be like this:
```
ğŸ“ my-awesome-app
  ğŸ“ src-main
    ğŸ“„ index.js
  ğŸ“ src-preload
    ğŸ“„ index.js
  ğŸ“ src
    [React source]

  ğŸ“ public
    ğŸ“„ main.js [generated by build-electron]
    ğŸ“„ preload.js [generated by build-electron]

  ğŸ“ build [generated by CRA]
  ğŸ“ dist [generated by electron-builder]

  ğŸ“„ package.json
  ğŸ“„ .gitignore
```

- `ğŸ“ src-main` - Source for the electron main process (where you create your `BrowserWindow`). Entry point `index.js` bundles to `public/main.js`.
- `ğŸ“ src-preload` - Source for the electron preload script. Entry point `index.js` bundles to `public/preload.js`.
- `ğŸ“ src` - Static frontend React files processed by CRA and outputted into `build`, along with files from `public`.
- `ğŸ“ public` - Output of `build-electron`'s entry points (`src-main` and `src-preload`), and is the input of the CRA build's static files.
- `ğŸ“ dist` - Final production app output generated by `electron-builder`.

Now create a configuration file in your project root `build-electron.config.js`:
```js
module.exports = {
  mainEntry: 'src-main/index.js',
  preloadEntry: 'src-preload/index.js',
  outDir: 'public',
  mainTarget: 'electron16.0-main',
  preloadTarget: 'electron16.0-preload',
}
```

Relevant bits to add to your `package.json`:
```json
  "main": "public/main.js",
  "build": {
    "extraMetadata": {
      "main": "build/main.js"
    },
    "files": [
      "build/**/*"
    ]
  },
  "scripts": {
    "start": "concurrently -k \"BROWSER=none react-scripts start\" \"build-electron -d\" \"wait-on public/.build-electron-done http://localhost:3000 && electron .\"",
    "build": "build-electron && react-scripts build",
    "postinstall": "electron-builder install-app-deps"
  }
```

Add to `.gitignore`:
```
/build
/dist
/icon-build
/public/main.js
/public/preload.js
```

Now you can start developing:
```bash
npm run start
```

And to build your production app:
```bash
npm run build && npm exec electron-builder --mac
```

## Using with Vite

I have successfully ported projects from Create React App to Vite. It's quite easy and usually involves:

- `package.json` `scripts.build` replace `react-scripts build` with: `vite build --outDir vite-dist`
- `package.json` `scripts.start` replace `react-scripts start` with: `vite dev`
- `package.json` `build.extraMetadata.main` replace `build/main.js` with `vite-dist/main.js`
- `package.json` `build.extraMetadata.files` replace `build/**/*` with `vite-dist/**/*`

Add to `.gitignore`:
```
/vite-dist
/dist
/icon-build
/public
```

TODO: show Vite example.

## `build-electron.config.js` options

Note that paths can be relative to project root or absolute.

- `mainEntry` - Electron's main entrypoint.
- `preloadEntry` - Electron's preload entrypoint.
- `mainExtraEntries`, `preloadExtraEntries` - Include additional main or preload entrypoints:
    - Key-value pairs, example: `{ 'name': 'path/to/source' }`
- `outDir` - Output files to this path.
- `externals` - Use this to [exclude](https://webpack.js.org/configuration/externals/) certain modules from being bundled, like native dependencies.
- `customConfig` - Customize Webpack config for both `main.js` and `preload.js`
- `customMainConfig` - Customize Webpack config just for `main.js`
- `customPreloadConfig` - Customize Webpack config just for `preload.js`
- `mainTarget` - Should use `electronX.Y-main`. See [Webpack target](https://webpack.js.org/configuration/target/)
- `preloadTarget` - Should use `electronX.Y-preload`. See [Webpack target](https://webpack.js.org/configuration/target/)

## `build-electron` CLI

- `--config`, `-c` - Override path to `build-electron.config.js` (default is in project root)
- `--dev`, `-d` - Run in development mode with file watcher (default is production build + exit after finish)

## Size optimizations

Make sure you follow these guidelines:

- Any npm dependencies that have binaries (native Node.js modules) must be in `dependencies` and included in the `externals` options so they don't get bundled in
- All other dependencies should be `devDependencies` to prevent them from being included by electron-builder.

## Source Maps

```bash
yarn add -D source-map-support
```

Add to the top of `src-main/index.js`:
```js
import 'source-map-support/register';
```

## TODO
- [Code splitting](https://webpack.js.org/plugins/split-chunks-plugin/)
- Figure out [Source Maps for preload](https://github.com/electron/electron/issues/24916)
- Create example project
- Environment variables

## Alternatives / inspiration

- https://github.com/alex8088/electron-vite
- https://github.com/cawa-93/vite-electron-builder - High maintenance to keep up-to-date with boilerplates.
- https://github.com/electron-userland/electron-compile **unmaintained**.
- https://github.com/electron-userland/electron-webpack - Somewhat outdated and **unmaintained**.
- Using [Vite](https://vitejs.dev/) instead of Webpack, however Vite is less popular and I've experienced issues with some npm modules. As Webpack is the de-facto standard way of building Javascript and used by so many developers, it was the best choice.
- https://github.com/vercel/ncc - Similar philosophy but [doesn't seem to work in electron](https://github.com/vercel/ncc/issues/539)

## Development

To test in a consuming project (yarn v2+), add to its `package.json`:
```json
"resolutions": {
  "build-electron": "portal:/path/to/build-electron"
}
```
then run `yarn`.
